<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAX WebView Landing</title>

  <!-- MAX Bridge (пример; подключите ваш реальный скрипт) -->
  <script src="https://st.max.ru/js/max-web-app.js"></script>

  <style>
    :root { 
        --bg:#f3f4f6; 
        --card:#f3f4f6;
        --text:#222; 
        --muted:#525252; 
    }
    * {
        box-sizing: border-box
    }
    html,body {
        height: 100%
    }
    body {
        margin: 0;
        font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
        background: var(--bg);
        color: var(--text)
    }

    /* Контент */
    .wrap {
        min-height: 100svh;
        display: grid;
        place-items: center;
        padding: 24px;
    }
    .card {
        width: min(720px,100%);
        background: var(--card);
        border: 1px solid rgba(255,255,255,.08);
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0,0,0,.35);
        padding: 28px;
        display: none;
    }
    .card.visible { 
        display: block;
    }
    h1 {
        margin: 0 0 8px;
        font-size: 28px;
    }
    p {
        margin: 0 0 16px;
        line-height: 1.5;
        color: var(--text);
    }
    .panel {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin: 18px 0 6px;
    }
    button,.linkbtn {
        appearance: none;
        border: 1px solid var(--muted);
        background: var(--card);
        color:var(--text);
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        font: inherit;
        transition: .2s;
        white-space: nowrap;
        text-decoration: none;
        display: inline-flex;
        gap: 8px;
        align-items: center;
    }
    button:hover,.linkbtn:hover{
        color: var(--muted);
        background: #e2e4e6;
    }
    code.url{
        display: block;
        overflow: auto;
        max-width: 100%;
        padding: 10px 12px;
        background: var(--card);
        border: 1px solid rgba(255,255,255,.08);
        border-radius: 10px;
        font-size: 13px;
        word-break: break-all;
    }
    .foot{
        margin-top: 18px;
        font-size: 12px;
        color: var(--muted);
    }

    .loaderOverlay {
      position: fixed;
      inset: 0; 
      display: grid;
      place-items: center;
      background: var(--bg);
      z-index: 1000;
      opacity: 1;
      transition: opacity .2s ease;
    }
    .loaderOverlay.hidden {
        opacity: 0;
        pointer-events: none;
    }
    .spinner {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 4px solid rgba(255,255,255,.2);
        border-top-color: #c1ff05;
        animation: spin 1s linear infinite;
        margin: 16px auto;
    }
    
    .loaderText {
        color:var(--muted);
        opacity: .9;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg);
        }
    }
  </style>
</head>
<body>

<div id="loader" class="loaderOverlay" aria-live="polite">
  <div style="text-align:center">
    <div class="spinner"></div>
    <div class="loaderText">Инициализация MAX…</div>
  </div>
</div>

<div class="wrap">
  <div id="card" class="card">
    <h1>Открой во внешнем браузере</h1>
    <p id="msg">Этот экран открыт в десктопном клиенте MAX. По требованиям безопасности основное приложение нужно открыть во внешнем браузере.</p>
    <div class="panel">
      <a id="openExternal" class="linkbtn" target="_blank" rel="noopener">Открыть</a>
      <button id="copy">Скопировать ссылку</button>
    </div>
    <code class="url" id="targetUrl">https://online.otpbank.ru/</code>
    <div class="foot">Если кнопка не сработала — скопируйте ссылку и вставьте в адресную строку браузера.</div>
  </div>
</div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const TARGET_DEFAULT = "https://online.otpbank.ru/"; 
  const target = (() => {
    try {
      const u = decodeURIComponent(params.get('to') || '');
      return u && /^https?:\/\//i.test(u) ? u : TARGET_DEFAULT;
    } catch { return TARGET_DEFAULT; }
  })();

  const $card = document.getElementById('card');
  const $loader = document.getElementById('loader');
  const $open = document.getElementById('openExternal');
  const $copy = document.getElementById('copy');
  const $url = document.getElementById('targetUrl');
  const $msg = document.getElementById('msg');

  $url.textContent = target;

  const MIN_LOADER_MS = 350;
  const DETECT_LIMIT  = 30; 
  const startTs = Date.now();

  const hideLoader = () =>  {
    const elapsed = Date.now() - startTs;
    const delay = Math.max(0, MIN_LOADER_MS - elapsed);
    setTimeout(() => $loader.classList.add('hidden'), delay);
  }

  const copyToClipboard = (text) => {
    return navigator.clipboard?.writeText(text).catch(() => {
      const linkPath = document.createElement('textarea');
      linkPath.value = text;
      document.body.appendChild(linkPath);
      linkPath.select();
      try { document.execCommand('copy'); } catch {}
      linkPath.remove();
    });
  }

  const showCard = (message) => {
    if (message) $msg.textContent = message;
    $open.href = target;
    $card.classList.add('visible');
    hideLoader();
  }

  const openExternally = () => {
    if (!!window?.WebApp) {
        window?.WebApp?.openLink(target); 
        return;
    }
    else { 
        window.open(target, '_blank', 'noopener'); 
    }
    location.href = target;
  }

  $open.addEventListener('click', function(e){
    e.preventDefault();
    console.log(e)
    openExternally();
  });

  $copy.addEventListener('click', async function(){
    await copyToClipboard(target);
    $copy.textContent = '✅ Скопировано';
    setTimeout(() => $copy.textContent = 'Скопировать ссылку', 1600);
  });

  const detectPlatform = () => {
    if (window.WebApp && typeof window.WebApp.platform === 'string') {
      return window.WebApp.platform;
    }
    const userAgent = navigator.userAgent.toLowerCase();
    if (/iphone|ipad|ipod|ios/.test(userAgent)) return 'ios';
    if (/android/.test(userAgent)) return 'android';
    return /electron|cef|edg\/|chrome\/|safari\//.test(userAgent) ? 'desktop' : 'web';
  }

  const go = (platform) => {
    try { 
        window.WebApp && window.WebApp.ready && window.WebApp.ready(); 
    } catch {}

    if (platform === 'ios' || platform === 'android') {
      location.replace(target);
      return;
    }

    showCard(platform === 'desktop'
      ? 'Не предназначен для десктопной версии. Откройте интернет-банк во внешнем браузере.'
      : 'Не предназначен для веб-версии. Откройте интернет-банк во внешнем браузере.');
  }

  let tries = 0;
  const timer = setInterval(() => {
    tries++;
    const platform = detectPlatform();
    if (platform || tries > DETECT_LIMIT) {
      clearInterval(timer);
      go(platform || 'web');
    }
  }, 50);

})();
</script>
</body>
</html>
